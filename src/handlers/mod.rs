//! –ú–æ–¥—É–ª—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ (Handlers).
//!
//! –≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ—É–Ω–∫—Ü–∏–∏-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ API.
//! –ö–∞–∂–¥—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞.
//!
//! # –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
//!
//! –í –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
//!
//! ```text
//! HTTP-–∑–∞–ø—Ä–æ—Å
//!      ‚Üì
//! ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
//! ‚îÇ  Handlers   ‚îÇ  ‚Üê –≠—Ç–æ—Ç –º–æ–¥—É–ª—å! –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã
//! ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
//!      ‚Üì
//! ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
//! ‚îÇ  Services   ‚îÇ  ‚Üê –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (—Ä–∞–±–æ—Ç–∞ —Å AI)
//! ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
//!      ‚Üì
//! ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
//! ‚îÇ   Models    ‚îÇ  ‚Üê –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö (Request/Response)
//! ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
//! ```
//!
//! Handler –ù–ï –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É - —Ç–æ–ª—å–∫–æ:
//! - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
//! - –í—ã–∑–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤
//! - –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
//!
//! # –ú–∞–∫—Ä–æ—Å—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ Rocket
//!
//! Rocket –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞—Ç—Ä–∏–±—É—Ç—ã-–º–∞–∫—Ä–æ—Å—ã –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π —Å HTTP-—ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏:
//!
//! - `#[get("/path")]` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ GET-–∑–∞–ø—Ä–æ—Å–æ–≤
//! - `#[post("/path")]` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ POST-–∑–∞–ø—Ä–æ—Å–æ–≤
//! - `#[catch(–∫–æ–¥)]` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ (404, 500 –∏ —Ç.–¥.)

// ============================================================================
// –ò–ú–ü–û–†–¢–´
// ============================================================================

// Json - –æ–±—ë—Ä—Ç–∫–∞ Rocket –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ JSON.
// –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ Json<T> Rocket –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
// 1. –°–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç T –≤ JSON
// 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Content-Type: application/json
use rocket::serde::json::Json;

// State - –º–µ—Ö–∞–Ω–∏–∑–º Dependency Injection –≤ Rocket.
// –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º —á–µ—Ä–µ–∑ .manage()
use rocket::State;

// –ú–∞–∫—Ä–æ—Å—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —è–≤–Ω–æ!
// Rocket 0.5 —Ç—Ä–µ–±—É–µ—Ç —è–≤–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞, –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π.
use rocket::{get, post, catch};

// tracing - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
// info! - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
// error! - —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
use tracing::{error, info};

use crate::config::AppConfig;
use crate::models::{AskRequest, AskResponse, ErrorResponse, HealthResponse};
use crate::services::AiService;

// ============================================================================
// –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –≠–ù–î–ü–û–ò–ù–¢–û–í
// ============================================================================

/// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± API.
///
/// # –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: Dependency Injection —á–µ—Ä–µ–∑ State
///
/// –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä `config: &State<AppConfig>`.
///
/// ## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?
///
/// 1. –í `main.rs` –º—ã –≤—ã–∑—ã–≤–∞–µ–º `.manage(config)` - –ø–µ—Ä–µ–¥–∞—ë–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ Rocket
/// 2. Rocket —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ—ë –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
/// 3. –í –ª—é–±–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –º—ã –º–æ–∂–µ–º "–∑–∞–ø—Ä–æ—Å–∏—Ç—å" —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ `State<T>`
/// 4. Rocket –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞—Å—Ç –Ω—É–∂–Ω—ã–π –æ–±—ä–µ–∫—Ç
///
/// ## –ü–æ—á–µ–º—É `&State<T>`, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ `T`?
///
/// - `State<T>` - —ç—Ç–æ smart pointer (—É–º–Ω—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å)
/// - `&State<T>` - —Å—Å—ã–ª–∫–∞ –Ω–∞ —ç—Ç–æ—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å
/// - –î–∞–Ω–Ω—ã–µ –ù–ï –∫–æ–ø–∏—Ä—É—é—Ç—Å—è, –º—ã –ø–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –æ–±—â–µ–º—É —ç–∫–∑–µ–º–ø–ª—è—Ä—É
///
/// –≠—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω "Dependency Injection" - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ "–≤–Ω–µ–¥—Ä—è—é—Ç—Å—è" –∏–∑–≤–Ω–µ,
/// –∞ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏.
///
/// # –≠–Ω–¥–ø–æ–∏–Ω—Ç
///
/// `GET /`
///
/// # –ü—Ä–∏–º–µ—Ä—ã
///
/// ```bash
/// curl http://localhost:8000/
/// ```
#[get("/")]
pub fn index(config: &State<AppConfig>) -> String {
    format!(
        "üöÄ {} v{}\n\n\
        {}\n\n\
        –î–æ—Å—Ç—É–ø–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:\n\
        - GET  /           - –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ\n\
        - GET  /health     - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞\n\
        - POST /ask        - –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å AI –ø–æ–º–æ—â–Ω–∏–∫—É\n\n\
        –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:\n\
        curl -X POST http://localhost:8000/ask \\\n\
          -H \"Content-Type: application/json\" \\\n\
          -d '{{\"question\": \"–ß—Ç–æ —Ç–∞–∫–æ–µ Rust?\"}}'",
        config.application.name,
        config.application.version,
        config.application.description
    )
}

/// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è.
///
/// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –µ–≥–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
/// –≠—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞.
///
/// # –≠–Ω–¥–ø–æ–∏–Ω—Ç
///
/// `GET /health`
///
/// # –û—Ç–≤–µ—Ç
///
/// ```json
/// {
///   "status": "ok",
///   "version": "0.1.0",
///   "gigachat_enabled": true
/// }
/// ```
///
/// # –ü—Ä–∏–º–µ—Ä—ã
///
/// ```bash
/// curl http://localhost:8000/health
/// ```
#[get("/health")]
pub fn health(config: &State<AppConfig>) -> Json<HealthResponse> {
    info!("Health check requested");

    Json(HealthResponse {
        status: "ok".to_string(),
        version: config.application.version.clone(),
        gigachat_enabled: config.is_gigachat_enabled(),
    })
}

/// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∫ AI - –≥–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å API.
///
/// # –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: –†–∞–∑–±–æ—Ä —Å–ª–æ–∂–Ω–æ–π —Å–∏–≥–Ω–∞—Ç—É—Ä—ã
///
/// ```text
/// #[post("/ask", format = "json", data = "<request>")]
/// ^^^^^^ ^^^^^^  ^^^^^^^^^^^^^^  ^^^^^^^^^^^^^^^^^
///   |      |          |                |
///   |      |          |                +-- –ò–º—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ —Å —Ç–µ–ª–æ–º –∑–∞–ø—Ä–æ—Å–∞
///   |      |          +------------------- –ü—Ä–∏–Ω–∏–º–∞–µ–º —Ç–æ–ª—å–∫–æ JSON
///   |      +------------------------------ URL-–ø—É—Ç—å
///   +-------------------------------------- HTTP-–º–µ—Ç–æ–¥ POST
///
/// pub async fn ask(
///     request: Json<AskRequest>,            // –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç—Å—è –∏–∑ JSON)
///     ai_service: &State<Box<dyn AiService>>, // AI-—Å–µ—Ä–≤–∏—Å –∏–∑ State (DI)
/// ) -> Result<Json<AskResponse>, Json<ErrorResponse>>
///      ^^^^^^ ^^^^^^^^^^^^^^^^^  ^^^^^^^^^^^^^^^^^^^^
///        |          |                    |
///        |          |                    +-- –û—à–∏–±–∫–∞ (–µ—Å–ª–∏ Result::Err)
///        |          +------------------------ –£—Å–ø–µ—Ö (–µ—Å–ª–∏ Result::Ok)
///        +----------------------------------- –¢–∏–ø Result –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –∏–ª–∏ Ok, –∏–ª–∏ Err
/// ```
///
/// ## –ó–∞—á–µ–º `Box<dyn AiService>`?
///
/// –í `State<>` —Ö—Ä–∞–Ω–∏—Ç—Å—è trait object - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø (GigaChat –∏–ª–∏ Mock)
/// –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã. –°–º. –º–æ–¥—É–ª—å `services`.
///
/// ## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ JSON
///
/// Rocket + Serde –¥–µ–ª–∞—é—Ç –º–∞–≥–∏—é:
/// 1. –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç: `{"question": "–ß—Ç–æ —Ç–∞–∫–æ–µ Rust?"}`
/// 2. Rocket –≤–∏–¥–∏—Ç `Json<AskRequest>` –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç JSON –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
/// 3. –ú—ã —Ä–∞–±–æ—Ç–∞–µ–º —Å `request.question` –∫–∞–∫ —Å –æ–±—ã—á–Ω—ã–º `String`
/// 4. –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ `Json<AskResponse>` - –æ–±—Ä–∞—Ç–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ JSON
///
/// # –≠–Ω–¥–ø–æ–∏–Ω—Ç
///
/// `POST /ask`
///
/// # –ü—Ä–∏–º–µ—Ä—ã
///
/// ```bash
/// curl -X POST http://localhost:8000/ask \
///   -H "Content-Type: application/json" \
///   -d '{"question": "–ß—Ç–æ —Ç–∞–∫–æ–µ Rust?"}'
/// ```
#[post("/ask", format = "json", data = "<request>")]
pub async fn ask(
    request: Json<AskRequest>,
    ai_service: &State<Box<dyn AiService>>,
) -> Result<Json<AskResponse>, Json<ErrorResponse>> {
    let question = &request.question;

    // –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å
    info!("Received question: {}", question);

    // Check that question is not empty
    if question.trim().is_empty() {
        error!("Empty question received");
        return Err(Json(ErrorResponse::with_code(
            "Question cannot be empty",
            "EMPTY_QUESTION",
        )));
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –≤ AI —Å–µ—Ä–≤–∏—Å –∏ –∂–¥—ë–º –æ—Ç–≤–µ—Ç
    match ai_service.ask(question).await {
        Ok(answer) => {
            info!("Successfully got answer from {}", ai_service.name());
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: –ó–î–ï–°–¨ —Å–æ–∑–¥–∞—ë—Ç—Å—è AskResponse!
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            //
            // AskResponse –ù–ï –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ API.
            // –ú—ã —Å–æ–∑–¥–∞—ë–º –µ–≥–æ –ü–†–û–ì–†–ê–ú–ú–ù–û –ø—Ä—è–º–æ –∑–¥–µ—Å—å:
            //
            // - `answer` - String, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç ai_service.ask()
            //   (–ª–∏–±–æ –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ GigaChat, –ª–∏–±–æ –æ—Ç MockAiService)
            //
            // - `source` - –ù–ê–®–ï –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –ø–æ–ª–µ, GigaChat API –æ –Ω—ë–º –Ω–µ –∑–Ω–∞–µ—Ç!
            //   ai_service.name() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "GigaChat" –∏–ª–∏ "Mock AI Service"
            //   .to_lowercase() –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –≤ "gigachat" –∏–ª–∏ "mock ai service"
            //
            // –ó–∞—Ç–µ–º Json(AskResponse{...}) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ JSON
            // –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É.
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            
            Ok(Json(AskResponse {
                answer,                                  // ‚Üê –∏–∑ AI —Å–µ—Ä–≤–∏—Å–∞
                source: ai_service.name().to_lowercase(), // ‚Üê –Ω–∞—à–µ –ø–æ–ª–µ
                system_prompt_applied: ai_service.system_prompt_applied(),
            }))
        }
        Err(e) => {
            error!("Error getting answer: {}", e);
            Err(Json(ErrorResponse::with_code(
                format!("Failed to get answer: {}", e),
                "AI_SERVICE_ERROR",
            )))
        }
    }
}

// ============================================================================
// –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –û–®–ò–ë–û–ö (CATCHERS)
// ============================================================================

// –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: Error Catchers –≤ Rocket
//
// "Catchers" (–ª–æ–≤—Ü—ã) - —ç—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫ HTTP.
// –û–Ω–∏ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∫–æ–≥–¥–∞:
// - –≠–Ω–¥–ø–æ–∏–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω (404)
// - –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (500)
// - –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ (400, 422)
//
// –ë–µ–∑ catchers Rocket –≤–µ—Ä–Ω—ë—Ç HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –æ—à–∏–±–∫–æ–π.
// –° catchers –º—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º JSON - —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è API!

/// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ (404 Not Found).
///
/// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç URL, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞.
///
/// # –ü—Ä–∏–º–µ—Ä—ã
///
/// ```bash
/// curl http://localhost:8000/nonexistent
/// # –í–µ—Ä–Ω—ë—Ç: {"error": "Endpoint not found...", "code": "NOT_FOUND"}
/// ```
#[catch(404)]
pub fn not_found() -> Json<ErrorResponse> {
    Json(ErrorResponse::with_code(
        "Endpoint not found. Use GET / to see available endpoints.",
        "NOT_FOUND",
    ))
}

/// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –æ—à–∏–±–æ–∫ —Å–µ—Ä–≤–µ—Ä–∞ (500 Internal Server Error).
///
/// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏—è—Ö (–ø–∞–Ω–∏–∫–∞—Ö) –≤ –∫–æ–¥–µ.
/// –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –≤–∞–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–∫–∏–µ –æ—à–∏–±–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.
#[catch(500)]
pub fn internal_error() -> Json<ErrorResponse> {
    Json(ErrorResponse::with_code(
        "Internal server error",
        "INTERNAL_ERROR",
    ))
}

/// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ (422 Unprocessable Entity).
///
/// # –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: –ö–æ–≥–¥–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç 422?
///
/// –≠—Ç–∞ –æ—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç, –∫–æ–≥–¥–∞:
/// - JSON —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω, –Ω–æ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
/// - –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
/// - –¢–∏–ø—ã –ø–æ–ª–µ–π –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ç—Ä–æ–∫–∞ –≤–º–µ—Å—Ç–æ —á–∏—Å–ª–∞)
///
/// –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤, –≤—ã–∑—ã–≤–∞—é—â–∏—Ö 422:
/// ```json
/// {}                           // –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ "question"
/// {"question": 123}            // question –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π
/// {"questions": "..."}         // –û–ø–µ—á–∞—Ç–∫–∞ –≤ –∏–º–µ–Ω–∏ –ø–æ–ª—è
/// ```
#[catch(422)]
pub fn unprocessable_entity() -> Json<ErrorResponse> {
    Json(ErrorResponse::with_code(
        "Invalid request format. Check your JSON.",
        "INVALID_REQUEST",
    ))
}

// ============================================================================
// –¢–ï–°–¢–´
// ============================================================================

/// # –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Rocket-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
///
/// Rocket –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π "—Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç" (`local::blocking::Client`),
/// –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å HTTP-–∑–∞–ø—Ä–æ—Å—ã –ë–ï–ó —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.
///
/// ```text
/// –û–±—ã—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
///   1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä (cargo run)
///   2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å curl-–∑–∞–ø—Ä–æ—Å
///   3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç
///
/// –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Rocket Client:
///   1. –°–æ–∑–¥–∞—Ç—å "–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π" Rocket
///   2. Client –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞–ø—Ä—è–º—É—é –≤ handlers
///   3. –ë—ã—Å—Ç—Ä–æ, –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ, –±–µ–∑ —Å–µ—Ç–∏
/// ```
#[cfg(test)]
mod tests {
    use crate::config::AppConfig;
    use crate::handlers::{health, index};
    // routes! - –º–∞–∫—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞—ë—Ç Vec –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–π-handlers
    use rocket::{routes, local::blocking::Client, Build, Rocket};

    /// –°–æ–∑–¥–∞—ë—Ç —Ç–µ—Å—Ç–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä Rocket (–±–µ–∑ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞).
    ///
    /// # –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: –ü–æ—á–µ–º—É `#[test]`, –∞ –Ω–µ `#[tokio::test]`?
    ///
    /// –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º `local::blocking::Client` - –°–ò–ù–•–†–û–ù–ù–£–Æ –≤–µ—Ä—Å–∏—é –∫–ª–∏–µ–Ω—Ç–∞.
    /// –û–Ω–∞ –ø—Ä–æ—â–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç async runtime.
    ///
    /// Rocket —Ç–∞–∫–∂–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç `local::asynchronous::Client` –¥–ª—è async-—Ç–µ—Å—Ç–æ–≤,
    /// –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Ç–µ—Å—Ç–æ–≤ blocking-–≤–µ—Ä—Å–∏—è —É–¥–æ–±–Ω–µ–µ.
    fn create_test_rocket() -> Rocket<Build> {
        let config = AppConfig::load().unwrap_or_else(|_| {
            panic!("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è —Ç–µ—Å—Ç–æ–≤");
        });

        // rocket::build() —Å–æ–∑–¥–∞—ë—Ç Rocket –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ Build (–µ—â—ë –Ω–µ –∑–∞–ø—É—â–µ–Ω)
        // .manage() –¥–æ–±–∞–≤–ª—è–µ—Ç State
        // .mount() —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –º–∞—Ä—à—Ä—É—Ç—ã
        rocket::build()
            .manage(config)
            .mount("/", routes![index, health])  // routes! - –º–∞–∫—Ä–æ—Å!
    }

    /// –¢–µ—Å—Ç: GET / –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK
    #[test]
    fn test_index() {
        // Client::tracked —Å–æ–∑–¥–∞—ë—Ç –∫–ª–∏–µ–Ω—Ç —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º cookies/sessions
        let client = Client::tracked(create_test_rocket()).expect("valid rocket instance");
        // .get("/") - —Å–æ–∑–¥–∞—ë—Ç GET-–∑–∞–ø—Ä–æ—Å
        // .dispatch() - "–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç" –µ–≥–æ (–Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –≤—ã–∑—ã–≤–∞–µ—Ç handler –Ω–∞–ø—Ä—è–º—É—é)
        let response = client.get("/").dispatch();
        assert_eq!(response.status().code, 200);
    }

    /// –¢–µ—Å—Ç: GET /health –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK
    #[test]
    fn test_health() {
        let client = Client::tracked(create_test_rocket()).expect("valid rocket instance");
        let response = client.get("/health").dispatch();
        assert_eq!(response.status().code, 200);
    }
}
