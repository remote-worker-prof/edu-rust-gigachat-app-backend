//! –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —É—á–µ–±–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ Rust —Å Rocket –∏ GigaChat API.
//!
//! # –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
//!
//! –≠—Ç–æ –≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (`main.rs`). –ó–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
//! 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
//! 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
//! 3. –°–æ–∑–¥–∞–Ω–∏–µ AI-—Å–µ—Ä–≤–∏—Å–∞ (GigaChat –∏–ª–∏ Mock)
//! 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ Rocket
//!
//! # –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
//!
//! ```text
//! main.rs (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
//!    ‚îÇ
//!    ‚îú‚îÄ‚îÄ config/    - –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ config.toml
//!    ‚îú‚îÄ‚îÄ models/    - –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö (Request/Response)
//!    ‚îú‚îÄ‚îÄ services/  - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (AI —Å–µ—Ä–≤–∏—Å—ã)
//!    ‚îî‚îÄ‚îÄ handlers/  - HTTP –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã API)
//! ```
//!
//! # –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
//!
//! ```text
//! cargo run
//!     ‚îÇ
//!     ‚ñº
//! #[launch] fn rocket()     ‚Üê Rocket –≤—ã–∑—ã–≤–∞–µ—Ç —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é
//!     ‚îÇ
//!     ‚îú‚îÄ‚ñ∫ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (AppConfig::load)
//!     ‚îú‚îÄ‚ñ∫ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤ (init_logging)
//!     ‚îú‚îÄ‚ñ∫ –°–æ–∑–¥–∞–Ω–∏–µ AI —Å–µ—Ä–≤–∏—Å–∞ (AiServiceFactory::create)
//!     ‚îî‚îÄ‚ñ∫ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ (rocket::custom(...).launch())
//! ```
//!
//! # –ó–∞–ø—É—Å–∫
//!
//! ```bash
//! # –ë–µ–∑ GigaChat (mock mode)
//! cargo run
//!
//! # –° GigaChat API
//! export GIGACHAT_TOKEN="your_token_here"
//! cargo run
//! ```

// ============================================================================
// –ò–ú–ü–û–†–¢–´ –ò –ú–ê–ö–†–û–°–´
// ============================================================================

// #[macro_use] extern crate rocket - –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –º–∞–∫—Ä–æ—Å—ã –∏–∑ –∫—Ä–µ–π—Ç–∞ rocket
// –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏. –≠—Ç–æ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å, –Ω–æ –æ–Ω –≤—Å—ë –µ—â—ë
// –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –º–∞–∫—Ä–æ—Å–æ–≤ routes! –∏ catchers!
//
// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å):
//   use rocket::{routes, catchers};
#[macro_use]
extern crate rocket;

// –û–±—ä—è–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞.
// `mod X;` –≥–æ–≤–æ—Ä–∏—Ç –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä—É: "–∑–∞–≥—Ä—É–∑–∏ —Ñ–∞–π–ª src/X/mod.rs (–∏–ª–∏ src/X.rs)"
mod config;
mod handlers;
mod models;
mod services;

// –ò–º–ø–æ—Ä—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–∑ –º–æ–¥—É–ª–µ–π –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
use config::AppConfig;
use handlers::{ask, health, index, internal_error, not_found, unprocessable_entity};
use services::AiServiceFactory;

// tracing - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è Rust
// –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–∞–¥ println!:
// - –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (error, warn, info, debug, trace)
// - –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏
// - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —É—Ä–æ–≤–Ω—è–º –∏ –º–æ–¥—É–ª—è–º
use tracing::{error, info};
use tracing_subscriber::{layer::SubscriberExt, util::SubscriberInitExt};

// ============================================================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø
// ============================================================================

/// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
///
/// # –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: –ó–∞—á–µ–º –Ω—É–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ?
///
/// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ - —ç—Ç–æ —Å–ø–æ—Å–æ–± –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ:
/// - –ü—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ: –æ—Ç–ª–∞–¥–∫–∞ –±–µ–∑ debugger'–∞
/// - –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ: –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º
///
/// ## –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–æ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º—É)
///
/// ```text
/// TRACE  ‚Üí  –û—á–µ–Ω—å –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–∫–∞–∂–¥—ã–π —à–∞–≥)
/// DEBUG  ‚Üí  –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
/// INFO   ‚Üí  –í–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (–∑–∞–ø—É—Å–∫, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ)
/// WARN   ‚Üí  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (—á—Ç–æ-—Ç–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ)
/// ERROR  ‚Üí  –û—à–∏–±–∫–∏ (—á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å)
/// ```
///
/// ## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
///
/// ```rust,ignore
/// info!("–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É {}", port);
/// error!("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î: {}", err);
/// ```
fn init_logging(config: &AppConfig) {
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –≤ enum —É—Ä–æ–≤–Ω—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
    // match - —ç—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω-–º–∞—Ç—á–∏–Ω–≥, –∞–Ω–∞–ª–æ–≥ switch –≤ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–∞—Ö,
    // –Ω–æ –±–æ–ª–µ–µ –º–æ—â–Ω—ã–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π.
    let log_level = match config.logging.level.as_str() {
        "trace" => tracing::Level::TRACE,
        "debug" => tracing::Level::DEBUG,
        "info" => tracing::Level::INFO,
        "warn" => tracing::Level::WARN,
        "error" => tracing::Level::ERROR,
        _ => tracing::Level::INFO, // _ - "–ª—é–±–æ–µ –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ" (default)
    };

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º tracing_subscriber - —ç—Ç–æ "–ø–æ–ª—É—á–∞—Ç–µ–ª—å" –ª–æ–≥–æ–≤.
    // Registry + layers - –ø–∞—Ç—Ç–µ—Ä–Ω "–°—Ç—Ä–æ–∏—Ç–µ–ª—å" (Builder).
    let log_format = config.logging.format.as_str();
    if log_format != "compact" {
        eprintln!("‚ö†Ô∏è  –§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤ '{log_format}' –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º compact");
    }

    let fmt_layer = tracing_subscriber::fmt::layer()
        .with_target(false)  // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–º—è –º–æ–¥—É–ª—è
        .with_level(true)    // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å (INFO, ERROR...)
        .compact();          // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞

    tracing_subscriber::registry()
        .with(
            // fmt::layer() - —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ª–æ–≥–∏ –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª—å
            fmt_layer,
        )
        .with(
            // –§–∏–ª—å—Ç—Ä - –∫–∞–∫–∏–µ –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
            tracing_subscriber::filter::Targets::new()
                .with_default(log_level)
                .with_target("rocket", tracing::Level::INFO), // Rocket –ª–æ–≥–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ INFO+
        )
        .init(); // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º subscriber –≥–ª–æ–±–∞–ª—å–Ω–æ

    info!(
        "–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (—É—Ä–æ–≤–µ–Ω—å: {}, —Ñ–æ—Ä–º–∞—Ç: {})",
        config.logging.level,
        config.logging.format
    );
}

// ============================================================================
// –¢–û–ß–ö–ê –í–•–û–î–ê
// ============================================================================

/// –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ - —Å–æ–∑–¥–∞—ë—Ç –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç Rocket —Å–µ—Ä–≤–µ—Ä.
///
/// # –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: –ê—Ç—Ä–∏–±—É—Ç #[launch]
///
/// `#[launch]` - —ç—Ç–æ –º–∞–∫—Ä–æ—Å Rocket, –∫–æ—Ç–æ—Ä—ã–π:
/// 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é `main()`
/// 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç async runtime (tokio)
/// 3. –í—ã–∑—ã–≤–∞–µ—Ç –Ω–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é `rocket()`
/// 4. –ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä
///
/// ## –í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–π —Ç–∏–ø `-> _`
///
/// `_` (underscore) –æ–∑–Ω–∞—á–∞–µ—Ç "–∫–æ–º–ø–∏–ª—è—Ç–æ—Ä, –≤—ã–≤–µ–¥–∏ —Ç–∏–ø —Å–∞–º".
/// –†–µ–∞–ª—å–Ω—ã–π —Ç–∏–ø: `Rocket<Build>` - —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –Ω–æ –Ω–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä.
///
/// ## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± (–±–µ–∑ #[launch])
///
/// ```rust,ignore
/// #[rocket::main]
/// async fn main() -> Result<(), rocket::Error> {
///     rocket().launch().await?;
///     Ok(())
/// }
/// ```
#[launch]
fn rocket() -> _ {
    // =========================================================================
    // –®–ê–ì 1: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    // =========================================================================
    // 
    // AppConfig::load() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Result<AppConfig, ConfigError>.
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º match –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±–æ–∏—Ö —Å–ª—É—á–∞–µ–≤ (Ok –∏ Err).
    let config = match AppConfig::load() {
        Ok(cfg) => {
            println!("‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
            cfg  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ match-–±–ª–æ–∫–∞
        }
        Err(e) => {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º eprintln! (error print) –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—à–∏–±–æ–∫ –≤ stderr
            eprintln!("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {}", e);
            eprintln!("üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª config.toml —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω");
            // std::process::exit(1) - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å –∫–æ–¥–æ–º –æ—à–∏–±–∫–∏
            // –ö–æ–¥ 0 = —É—Å–ø–µ—Ö, –ª—é–±–æ–π –¥—Ä—É–≥–æ–π = –æ—à–∏–±–∫–∞
            std::process::exit(1);
        }
    };

    // =========================================================================
    // –®–ê–ì 2: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    // =========================================================================
    init_logging(&config);

    // –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    info!("üöÄ –ó–∞–ø—É—Å–∫ {}", config.application.name);
    info!("üì¶ –í–µ—Ä—Å–∏—è: {}", config.application.version);
    info!("üåç –û–∫—Ä—É–∂–µ–Ω–∏–µ: {}", config.server.environment);
    if config.is_development() {
        info!("üß™ –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≤–∫–ª—é—á—ë–Ω");
    }
    info!(
        "üîß GigaChat API: {}",
        if config.is_gigachat_enabled() { "–≤–∫–ª—é—á—ë–Ω" } else { "–≤—ã–∫–ª—é—á–µ–Ω (mock mode)" }
    );
    info!("‚è±Ô∏è –¢–∞–π–º–∞—É—Ç GigaChat: {}s", config.gigachat.timeout_seconds);
    info!(
        "üìù System prompt length: {} chars",
        config.application.system_prompt.chars().count()
    );

    // =========================================================================
    // –®–ê–ì 3: –°–æ–∑–¥–∞–Ω–∏–µ AI —Å–µ—Ä–≤–∏—Å–∞
    // =========================================================================
    //
    // –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ç–∏–ø –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π:
    //   Box<dyn services::AiService>
    // –≠—Ç–æ trait object - –º—ã –Ω–µ –∑–Ω–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø (GigaChat –∏–ª–∏ Mock),
    // –Ω–æ –∑–Ω–∞–µ–º, —á—Ç–æ –æ–Ω —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Ç—Ä–µ–π—Ç AiService.
    let system_prompt = if config.application.system_prompt.trim().is_empty() {
        None
    } else {
        Some(config.application.system_prompt.clone())
    };

    let ai_service: Box<dyn services::AiService> = if config.is_gigachat_enabled() {
        // –í–ª–æ–∂–µ–Ω–Ω—ã–π match - –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
        match config.get_gigachat_token() {
            Ok(token) => {
                info!("‚úÖ –¢–æ–∫–µ–Ω GigaChat –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π API");
                AiServiceFactory::create(&config.gigachat, Some(token), system_prompt)
            }
            Err(_) => {
                // –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–æ —ç—Ç–æ –ù–ï —Ñ–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º mock
                error!("‚ö†Ô∏è  –¢–æ–∫–µ–Ω GigaChat –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è GIGACHAT_TOKEN");
                info!("üí° –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ mock mode");
                AiServiceFactory::create(&config.gigachat, None, None)
            }
        }
    } else {
        info!("‚ÑπÔ∏è  GigaChat API –æ—Ç–∫–ª—é—á—ë–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º mock mode");
        AiServiceFactory::create(&config.gigachat, None, None)
    };

    info!("ü§ñ AI —Å–µ—Ä–≤–∏—Å: {}", ai_service.name());

    // =========================================================================
    // –®–ê–ì 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Rocket
    // =========================================================================
    //
    // Figment - —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Rocket.
    // .merge() –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
    // –ó–¥–µ—Å—å –º—ã –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥—Ä–µ—Å –∏ –ø–æ—Ä—Ç –∏–∑ –Ω–∞—à–µ–≥–æ config.toml.
    let figment = rocket::Config::figment()
        .merge(("address", config.server.address.clone()))
        .merge(("port", config.server.port));

    info!("üåê –°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞ {}:{}", config.server.address, config.server.port);

    // =========================================================================
    // –®–ê–ì 5: –°–±–æ—Ä–∫–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ Rocket
    // =========================================================================
    //
    // –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: –ú–µ—Ç–æ–¥-—Ü–µ–ø–æ—á–∫–∞ (Method Chaining)
    //
    // –ö–∞–∂–¥—ã–π –º–µ—Ç–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç self, –ø–æ–∑–≤–æ–ª—è—è –≤—ã–∑—ã–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Ç–æ–¥.
    // –≠—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω "–°—Ç—Ä–æ–∏—Ç–µ–ª—å" (Builder Pattern).
    //
    // .manage(T)    - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç T –≤ State, –¥–æ—Å—Ç—É–ø–µ–Ω –≤–æ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
    // .mount("/", routes![...])   - —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ –ø—É—Ç–∏ "/"
    // .register("/", catchers![...]) - —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫
    rocket::custom(figment)
        .manage(config)      // State<AppConfig> - –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ &State<AppConfig>
        .manage(ai_service)  // State<Box<dyn AiService>> - AI —Å–µ—Ä–≤–∏—Å
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: –ú–∞–∫—Ä–æ—Å—ã routes! –∏ catchers!
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        //
        // routes![index, health, ask] - —ç—Ç–æ –ú–ê–ö–†–û–°, –Ω–µ —Ñ—É–Ω–∫—Ü–∏—è!
        // –û–Ω –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏–º–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–π –≤ Vec<Route>.
        //
        // –ë–µ–∑ –º–∞–∫—Ä–æ—Å–∞ –ø—Ä–∏—à–ª–æ—Å—å –±—ã –ø–∏—Å–∞—Ç—å:
        //   vec![
        //       Route::new(Method::Get, "/", index),
        //       Route::new(Method::Get, "/health", health),
        //       Route::new(Method::Post, "/ask", ask),
        //   ]
        //
        // –ú–∞–∫—Ä–æ—Å —á–∏—Ç–∞–µ—Ç –∞—Ç—Ä–∏–±—É—Ç—ã #[get("/")] –∏ #[post("/ask")] –∏–∑ —Ñ—É–Ω–∫—Ü–∏–π
        // –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ Route-–æ–±—ä–µ–∫—Ç—ã.
        //
        // catchers! —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π —Å #[catch(–∫–æ–¥)]
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        .mount("/", routes![index, health, ask])
        .register("/", catchers![not_found, internal_error, unprocessable_entity])
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_config_loading() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
        let result = AppConfig::load();
        assert!(result.is_ok() || result.is_err()); // –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
    }
}
