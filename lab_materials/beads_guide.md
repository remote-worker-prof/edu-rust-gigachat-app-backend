# Практикум: Beads и единый workflow с Git

Этот проект использует **beads** как встроенный issue‑трекер. Beads хранит задачи
прямо в репозитории (в `.beads/issues.jsonl`) и синхронизируется с git‑историей.

## 1. Зачем это нужно в учебном проекте

- задачи хранятся рядом с кодом и путешествуют вместе с репозиторием;
- не нужен отдельный веб‑интерфейс;
- удобно фиксировать учебные шаги и командную работу.

## 2. Минимальные команды

```bash
# Создать задачу (с описанием — так сохраняется контекст)
bd create "Сформулировать новый эндпоинт" \
  --type task --priority 2 \
  --description "Коротко: что нужно сделать и зачем"

# Посмотреть список задач
bd list

# Перевести задачу в работу
bd update <id> --status in_progress

# Закрыть задачу
bd close <id>
```

## 3. Единый workflow beads + git (обязательный)

1. **Создайте задачу в beads** перед началом работы.
2. **Отметьте задачу как in_progress**.
3. Внесите изменения в код и документацию.
4. **Добавьте изменения в индекс** (`git add -A`).
5. **Сделайте commit проекта** по правилам ниже.
6. **Закройте задачу** после завершения.
7. **Выполните `bd sync`**, если синхронизация не прошла автоматически.

Beads умеет автоматически синхронизироваться с git через хуки. Проверьте,
что хуки установлены:

```bash
bd hooks install
```

Если хуки не установлены или были удалены, выполните команду ещё раз.

## 3.1. Рекомендуемый режим по документации beads

Разработчики beads рекомендуют **автоматический режим синхронизации**:

1. **Auto‑sync** базы и `.beads/issues.jsonl` (происходит автоматически).
2. **Git‑хуки** обеспечивают согласованность перед commit/push и после merge.
3. **Merge‑driver** для `.beads/issues.jsonl`, чтобы не решать конфликты вручную.

Что нужно сделать один раз:

```bash
bd init
bd hooks install

git config merge.beads.driver true
```

Ручные команды `bd sync / bd export / bd import` используются только как
резервный вариант, если auto‑sync/хуки по какой‑то причине не сработали.
`bd sync` **по умолчанию выполняет `git pull` и `git push`**, поэтому отдельный
`git pull` до/после него не нужен. Если используется `bd sync`, он коммитит
**только** `.beads/issues.jsonl`
и **не коммитит** изменения проекта. Поэтому:

- изменения проекта всегда добавляйте в индекс (`git add -A`);
- коммит проекта выполняйте вручную;
- `bd sync` запускайте уже после коммита проекта и закрытия задачи.

Если `.beads/issues.jsonl` случайно попал в индекс вместе с проектными
файлами, его можно исключить и оставить для `bd sync`:
```bash
git restore --staged .beads/issues.jsonl
```

## 4. Что хранится в репозитории

- `.beads/issues.jsonl` — журнал задач (отслеживается git).
- `.beads/metadata.json` — техническая информация.

## 5. Типичные проблемы

### Ошибка: "LEGACY DATABASE DETECTED"

Эта ошибка означает, что база beads была создана в старой версии
и не содержит идентификатор репозитория.

Исправление для текущего репозитория:
```bash
bd migrate --update-repo-id
```

Если это свежий клон и история задач не нужна:
```bash
rm -rf .beads && bd init
```

## 6. Рекомендации по учебной работе

- Фиксируйте каждую значимую задачу в beads.
- Делайте небольшие коммиты с понятными сообщениями.
- Не удаляйте `.beads/issues.jsonl` без согласования с преподавателем.

### Мини‑пример, чтобы избежать ошибки

Если вы отредактировали, например, `src/main.rs`, но не сделали `git add -A`
и `git commit`, то `bd sync` **не сохранит** этот файл. В результате
в репозитории появятся только изменения beads, а ваш код останется локальным.

## 6.1. Правила сообщения коммита (issue → commit)

Требование:
- первая строка в формате **`[<issue-id>] <type>(P#): <issue title>`**;
- тело коммита **совпадает с `--description`**;
- после описания идёт **список изменённых файлов**.

ID задач для этого репозитория имеют префикс `ergab-` (строчные буквы).

Памятка статусов (общепринятая git-нотация):
- A — файл создан (Added)
- M — файл изменён (Modified)
- D — файл удалён (Deleted)
- R — файл переименован (Renamed)
- C — файл скопирован (Copied)

Шаблон:
```bash
ID="<issue id>"
TYPE="<issue type>"
PRIO="<issue priority>"
TITLE="<issue title>"
DESC="<issue description>"
HEADER="[$ID] $TYPE($PRIO): $TITLE"
FILES=$(git diff --cached --name-only | sed 's/^/- /')
printf "%s\n\n%s\n\nИзменения:\n%s\n" "$HEADER" "$DESC" "$FILES" | git commit -F -
```

Вариант со статусами файлов (A/M/D/R/C + пояснение):
```bash
ID="<issue id>"
TYPE="<issue type>"
PRIO="<issue priority>"
TITLE="<issue title>"
DESC="<issue description>"
HEADER="[$ID] $TYPE($PRIO): $TITLE"
FILES=$(git diff --cached --name-status | awk '
  {
    code=$1; from=$2; to=$3;
    status="изменён";
    if (code ~ /^A/) status="создан";
    else if (code ~ /^D/) status="удалён";
    else if (code ~ /^R/) { status="переименован"; printf "- %s %s -> %s (%s)\n", code, from, to, status; next }
    else if (code ~ /^C/) { status="скопирован"; printf "- %s %s -> %s (%s)\n", code, from, to, status; next }
    printf "- %s %s (%s)\n", code, from, status;
  }')
printf "%s\n\n%s\n\nИзменения:\n%s\n" "$HEADER" "$DESC" "$FILES" | git commit -F -
```

## 7. Памятка: как писать описание задачи

Хорошее описание отвечает на вопросы **что** и **зачем**.

**Примеры:**

✅ Хорошо:
- `--description "Добавить эндпоинт /stats, чтобы показывать сводку для преподавателя"`
- `--description "Сделать проверку пустого question, чтобы вернуть 400 вместо паники"`

❌ Плохо:
- `--description "Сделать задачу"`
- `--description "Нужно исправить"`
